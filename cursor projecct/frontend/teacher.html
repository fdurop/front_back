<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ•™å¸ˆç•Œé¢ - fduropæ™ºèƒ½é—®ç­”åŠ©æ‰‹</title>
  <link rel="stylesheet" href="./styles.css">
  <meta name="color-scheme" content="light dark">
</head>
<body>
  <div class="app">
    <!-- Header will be loaded here -->
    <div id="headerContainer"></div>
    
    <main class="app-main">
      <div class="teacher-welcome">
        <div class="welcome-icon">ğŸ«</div>
        <h1 class="welcome-title">æ¬¢è¿ä½¿ç”¨æ•™å¸ˆç•Œé¢</h1>
        <p class="welcome-subtitle">æ‚¨å·²æˆåŠŸç™»å½•ä¸ºæ•™å¸ˆèº«ä»½</p>
        
      </div>
      
      
      
      <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
      <div class="file-upload-section" id="uploadSection" hidden>
        <h2 class="upload-title">æ•™å­¦èµ„æºä¸Šä¼ </h2>
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon"></div>
          <p class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
          <p class="upload-hint">æ”¯æŒ PDFã€Wordã€PPTã€å›¾ç‰‡ç­‰æ ¼å¼</p>
          <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.txt" hidden>
          <button class="upload-btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
        </div>
        
        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div class="file-list" id="fileList">
          <h3 class="file-list-title">å·²ä¸Šä¼ æ–‡ä»¶</h3>
          <div class="file-items" id="fileItems">
            <div class="no-files">æš‚æ— æ–‡ä»¶</div>
          </div>
        </div>
        
        <!-- ä¸Šä¼ è¿›åº¦ -->
        <div class="upload-progress" id="uploadProgress" hidden>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">ä¸Šä¼ ä¸­... 0%</div>
        </div>
        
        <!-- çŠ¶æ€æ¶ˆæ¯ -->
        <div class="status-message" id="statusMessage" hidden></div>
      </div>
    </main>
  </div>

  <!-- å…ˆåŠ è½½headerç»„ä»¶ -->
  <script src="./components/header-loader.js"></script>
  <script>
    // ç­‰å¾…headeråŠ è½½å®Œæˆåå†åˆå§‹åŒ–æ•™å¸ˆç•Œé¢
    async function initializeTeacherApp() {
      try {
        // åŠ è½½header
        await window.headerLoader.load();
        
        // ç­‰å¾…headerå®Œå…¨åŠ è½½
        await window.headerLoader.waitForLoad();
        
        // è®¾ç½®æ•™å¸ˆè§’è‰²
        window.headerLoader.setRoleText('teacher');
        
        // åˆå§‹åŒ–æ•™å¸ˆç•Œé¢é€»è¾‘
        initializeTeacherInterface();
        
      } catch (error) {
        console.error('åˆå§‹åŒ–æ•™å¸ˆç•Œé¢å¤±è´¥:', error);
        // å³ä½¿å¤±è´¥ä¹Ÿè¦åˆå§‹åŒ–ç•Œé¢
        initializeTeacherInterface();
      }
    }
    
    // åˆå§‹åŒ–æ•™å¸ˆç•Œé¢
    function initializeTeacherInterface() {
      // ç¡®ä¿å½“å‰è§’è‰²æ˜¯æ•™å¸ˆ
      if (localStorage.getItem('qa_user_role') !== 'teacher') {
        localStorage.setItem('qa_user_role', 'teacher');
      }
      
      // åˆå§‹åŒ–headeræŒ‰é’®åŠŸèƒ½
      initializeHeaderButtons();
      
      // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½...
      initializeFileUpload();
    }
    
    // åˆå§‹åŒ–headeræŒ‰é’®åŠŸèƒ½
    function initializeHeaderButtons() {
      // è·å–headerä¸­çš„æŒ‰é’®å…ƒç´ 
      const mockToggle = window.headerLoader.getElement('mockToggle');
      const roleBtn = window.headerLoader.getElement('roleBtn');
      const configBtn = window.headerLoader.getElement('configBtn');
      const loginBtn = window.headerLoader.getElement('loginBtn');
      const clearBtn = window.headerLoader.getElement('clearBtn');
      const backendStatus = window.headerLoader.getElement('backendStatus');
      
      // è®¾ç½®åç«¯çŠ¶æ€
      if (backendStatus) {
        backendStatus.textContent = 'åç«¯ï¼šæ£€æŸ¥ä¸­â€¦';
      }
      
      // Mockåˆ‡æ¢åŠŸèƒ½
      if (mockToggle) {
        // æ¢å¤mockçŠ¶æ€
        try {
          const mock = localStorage.getItem('qa_mock_mode');
          mockToggle.checked = mock === '1';
        } catch (e) {}
        
        mockToggle.addEventListener('change', () => {
          localStorage.setItem('qa_mock_mode', mockToggle.checked ? '1' : '0');
        });
      }
      
      // è§’è‰²åˆ‡æ¢åŠŸèƒ½
      if (roleBtn) {
        roleBtn.addEventListener('click', () => {
          const currentRole = localStorage.getItem('qa_user_role');
          const nextRole = currentRole === 'student' ? 'teacher' : 'student';
          localStorage.setItem('qa_user_role', nextRole);
          
          // æ ¹æ®æ–°è§’è‰²è·³è½¬é¡µé¢
          if (nextRole === 'student') {
            window.location.href = './index.html';
          } else {
            window.location.href = './teacher.html';
          }
        });
      }
      
      // è®¾ç½®åç«¯åŠŸèƒ½
      if (configBtn) {
        configBtn.addEventListener('click', async () => {
          try {
            const current = localStorage.getItem('qa_api_endpoint') || 'http://127.0.0.1:8000/api/ask';
            const next = prompt('è¯·è¾“å…¥åç«¯ /api/ask åœ°å€ï¼š', current);
            if (!next) return;
            localStorage.setItem('qa_api_endpoint', next);
            alert('å·²ä¿å­˜ã€‚');
          } catch (e) {}
        });
      }
      
      // ç™»å½•åŠŸèƒ½
      if (loginBtn) {
        loginBtn.addEventListener('click', () => {
          // åœ¨æ•™å¸ˆç•Œé¢ï¼Œç›´æ¥æ˜¾ç¤ºç™»å½•æˆåŠŸ
          alert('æ•™å¸ˆèº«ä»½å·²è‡ªåŠ¨ç™»å½•');
        });
      }
      
      // æ¸…ç©ºå¯¹è¯åŠŸèƒ½
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
            // åœ¨æ•™å¸ˆç•Œé¢ï¼Œè¿™ä¸ªåŠŸèƒ½å¯èƒ½ä¸éœ€è¦ï¼Œä½†ä¿æŒä¸€è‡´æ€§
            alert('æ•™å¸ˆç•Œé¢æ— éœ€æ¸…ç©ºå¯¹è¯');
          }
        });
      }
      
      // åˆ é™¤äº†è¿”å›å­¦ç”Ÿç•Œé¢æŒ‰é’®çš„ä»£ç 
    }
    
    // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
    function initializeFileUpload() {
      // ä¸Šä¼ åŒºåŸŸå…ƒç´ 
      const uploadSection = document.getElementById('uploadSection');
      // æ–‡ä»¶ä¸Šä¼ ç›¸å…³å…ƒç´ 
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      const fileItems = document.getElementById('fileItems');
      const uploadProgress = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const statusMessage = document.getElementById('statusMessage');
      
      // åç«¯APIåœ°å€
      const API_BASE = 'http://127.0.0.1:8000';
      
      // æ£€æŸ¥åç«¯è¿æ¥ï¼Œä»…æ›´æ–°å¤´éƒ¨çŠ¶æ€å±•ç¤ºï¼Œä½¿ä¹‹ä¸ student ä¸€è‡´
      async function checkBackendConnection() {
        try {
          const response = await fetch(`${API_BASE}/health`, {
            method: 'GET',
            mode: 'cors'
          });
          
          if (response.ok) {
            // æ›´æ–°headerä¸­çš„åç«¯çŠ¶æ€
            const headerBackendStatus = window.headerLoader.getElement('backendStatus');
            if (headerBackendStatus) {
              headerBackendStatus.textContent = 'åç«¯ï¼šåœ¨çº¿';
              headerBackendStatus.title = API_BASE;
            }
            uploadSection.hidden = false;
            loadFileList();
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
          
        } catch (error) {
          console.error('åç«¯è¿æ¥å¤±è´¥:', error);
          // æ›´æ–°headerä¸­çš„åç«¯çŠ¶æ€
          const headerBackendStatus = window.headerLoader.getElement('backendStatus');
          if (headerBackendStatus) {
            headerBackendStatus.textContent = 'åç«¯ï¼šç¦»çº¿ï¼ˆå°†ä½¿ç”¨ç¤ºä¾‹ç­”æ¡ˆï¼‰';
            headerBackendStatus.title = 'è¯·å¯åŠ¨åç«¯æˆ–è®¾ç½®å¯ç”¨çš„ /api/ask åœ°å€';
          }
          // ä»å…è®¸æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸï¼Œç”±ç”¨æˆ·è‡ªè¡Œå°è¯•
          uploadSection.hidden = false;
        }
      }
      // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¸€æ¬¡
      checkBackendConnection();
      
      // æ‹–æ‹½ä¸Šä¼ 
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        handleFiles(files);
      });
      
      // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
      fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        handleFiles(files);
      });
      
      // å¤„ç†æ–‡ä»¶
      function handleFiles(files) {
        Array.from(files).forEach(file => {
          uploadFile(file);
        });
      }
      
      // ä¸Šä¼ æ–‡ä»¶åˆ°åç«¯
      async function uploadFile(file) {
        try {
          // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
          uploadProgress.hidden = false;
          progressFill.style.width = '0%';
          progressText.textContent = 'å‡†å¤‡ä¸Šä¼ ...';
          
          // åˆ›å»ºFormData
          const formData = new FormData();
          formData.append('file', file);
          
          // æ·»åŠ è®¤è¯ä¿¡æ¯
          const token = localStorage.getItem('qa_auth_token');
          const role = localStorage.getItem('qa_user_role');
          
          // å‘é€ä¸Šä¼ è¯·æ±‚
          const response = await fetch(`${API_BASE}/api/upload`, {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Authorization': token ? `Bearer ${token}` : '',
              'X-User-Role': role || 'teacher'
            },
            body: formData
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }
          
          const result = await response.json();
          
          if (result.success) {
            // ä¸Šä¼ æˆåŠŸ
            progressFill.style.width = '100%';
            progressText.textContent = 'ä¸Šä¼ å®Œæˆï¼';
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showStatus('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼', 'success');
            
            // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
            setTimeout(() => {
              loadFileList();
              uploadProgress.hidden = true;
            }, 1000);
            
          } else {
            throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
          }
          
        } catch (error) {
          console.error('ä¸Šä¼ å¤±è´¥:', error);
          progressText.textContent = 'ä¸Šä¼ å¤±è´¥';
          showStatus(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
          
          setTimeout(() => {
            uploadProgress.hidden = true;
          }, 2000);
        }
      }
      
      // åŠ è½½æ–‡ä»¶åˆ—è¡¨
      async function loadFileList() {
        try {
          const token = localStorage.getItem('qa_auth_token');
          const role = localStorage.getItem('qa_user_role');
          
          const response = await fetch(`${API_BASE}/api/files`, {
            method: 'GET',
            mode: 'cors',
            headers: {
              'Authorization': token ? `Bearer ${token}` : '',
              'X-User-Role': role || 'teacher'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const result = await response.json();
          
          if (result.success) {
            renderFileList(result.files);
          } else {
            throw new Error(result.error || 'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
          }
          
        } catch (error) {
          console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
          showStatus(`è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
        }
      }
      
      // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
      function renderFileList(files) {
        fileItems.innerHTML = '';
        
        if (files.length === 0) {
          const noFiles = document.createElement('div');
          noFiles.className = 'no-files';
          noFiles.textContent = 'æš‚æ— æ–‡ä»¶';
          fileItems.appendChild(noFiles);
        }
        
        files.forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <div class="file-info">
              <span class="file-icon">${getFileIcon(file.filename)}</span>
              <div class="file-details">
                <div class="file-name">${file.filename}</div>
                <div class="file-size">${formatFileSize(file.size)}</div>
              </div>
            </div>
            <div class="file-actions">
              <button class="file-action-btn" onclick="deleteFile('${file.filename}')" title="åˆ é™¤æ–‡ä»¶">ğŸ—‘ï¸</button>
            </div>
          `;
          fileItems.appendChild(fileItem);
        });
      }
      
      // åˆ é™¤æ–‡ä»¶
      window.deleteFile = async function(filename) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
          return;
        }
        
        try {
          const token = localStorage.getItem('qa_auth_token');
          const role = localStorage.getItem('qa_user_role');
          
          const response = await fetch(`${API_BASE}/api/files/${encodeURIComponent(filename)}`, {
            method: 'DELETE',
            mode: 'cors',
            headers: {
              'Authorization': token ? `Bearer ${token}` : '',
              'X-User-Role': role || 'teacher'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const result = await response.json();
          
          if (result.success) {
            showStatus('æ–‡ä»¶åˆ é™¤æˆåŠŸï¼', 'success');
            loadFileList(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
          } else {
            throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
          }
          
        } catch (error) {
          console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
          showStatus(`åˆ é™¤æ–‡ä»¶å¤±è´¥: ${error.message}`, 'error');
        }
      }
      
      // è·å–æ–‡ä»¶å›¾æ ‡
      function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
          'pdf': '',
          'doc': 'ğŸ“',
          'docx': '',
          'ppt': 'ğŸ“Š',
          'pptx': '',
          'jpg': 'ï¸',
          'jpeg': 'ğŸ–¼ï¸',
          'png': 'ğŸ–¼ï¸',
          'gif': 'ğŸ–¼ï¸',
          'txt': 'ğŸ“„'
        };
        return iconMap[ext] || 'ğŸ“';
      }
      
      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      
      // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
      function showStatus(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.className = `status-message ${type}`;
        statusMessage.hidden = false;
        
        setTimeout(() => {
          statusMessage.hidden = true;
        }, 3000);
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', initializeTeacherApp);
  </script>
</body>
</html>
